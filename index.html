<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Accessible Guam Map</title>

<style>
body { margin:0; font-family:system-ui,sans-serif; background:#f4f6f8; }
header { background:#2d8cf0; color:white; padding:18px; text-align:center; }
.container { max-width:1100px; margin:auto; padding:12px; }
#map { height:65vh; border-radius:18px; margin-top:10px; }

.search-box { width:100%; padding:12px; border-radius:14px; border:1px solid #ccc; }

.form-toggle { margin:12px auto; display:block; padding:12px 20px; border-radius:999px; border:none; background:#2d8cf0; color:white; cursor:pointer; }

.form-card { background:white; border-radius:20px; padding:16px; margin-bottom:12px; display:none; }
.form-card.show { display:block; }

input[type="text"] { width:100%; padding:10px 12px; border-radius:14px; border:1px solid #ccc; margin-bottom:10px; }

.file-label { display:inline-block; padding:10px 14px; border-radius:14px; background:#eaf4ff; cursor:pointer; }
.file-label input { display:none; }

.tags { display:flex; gap:14px; margin:10px 0; }

.post-btn { width:100%; padding:12px; border-radius:999px; border:none; background:#2d8cf0; color:white; cursor:pointer; }

.filters { display:flex; gap:8px; margin:12px 0; flex-wrap:wrap; }
.filters button { padding:6px 12px; border-radius:999px; border:none; cursor:pointer; }
.filters .active { background:#2d8cf0; color:white; }

.modal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; }
.modal-content { background:white; padding:16px; border-radius:16px; }
.modal img { max-width:90vw; border-radius:12px; }
</style>
</head>

<body>

<header>
  <h2>Accessible Guam Map</h2>
  <p>Anyone can share accessibility information</p>
</header>

<div class="container">

<input id="searchBox" class="search-box" placeholder="Search places on map">

<button class="form-toggle" onclick="toggleForm()">Ôºã Add new spot</button>

<div class="form-card" id="formCard">
  <input id="placeName" type="text" placeholder="Place name">
  <input id="commentInput" type="text" placeholder="Comment">

  <label class="file-label">
    Choose image
    <input id="imageInput" type="file" accept="image/*">
  </label>

  <div class="tags">
    <label><input type="checkbox" value="slope"> #slope</label>
    <label><input type="checkbox" value="wheelchair"> #wheelchair</label>
    <label><input type="checkbox" value="toilet"> #toilet</label>
  </div>

  <button class="post-btn" onclick="addSpot()">Post</button>
</div>

<div class="filters">
  <button class="active" onclick="filterMarkers('all',this)">Show all</button>
  <button onclick="filterMarkers('slope',this)">#slope</button>
  <button onclick="filterMarkers('wheelchair',this)">#wheelchair</button>
  <button onclick="filterMarkers('toilet',this)">#toilet</button>
</div>

<div id="map"></div>
</div>

<div class="modal" id="imageModal" onclick="this.style.display='none'">
  <div class="modal-content" onclick="event.stopPropagation()">
    <img id="modalImg"><br><br>
    <a id="downloadLink" download>Download image</a>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyCjb_BYuBWpNSq_VCOlfdproM-BeKHus6c",
  authDomain: "accessible-guam-map.firebaseapp.com",
  projectId: "accessible-guam-map",
  storageBucket: "accessible-guam-map.firebasestorage.app",
  messagingSenderId: "422773836973",
  appId: "1:422773836973:web:963f88b1a2b810f301ca24"
};

initializeApp(firebaseConfig);
const db = getFirestore();
const storage = getStorage();

/* userIdÔºà„É≠„Ç∞„Ç§„É≥‰∏çË¶Å„Éª1ÂõûÁîüÊàêÔºâ */
if (!localStorage.getItem("userId")) {
  localStorage.setItem("userId", crypto.randomUUID());
}

let map;
let selectedLatLng = null;
let markers = [];

/* Google Map */
window.initMap = () => {
  map = new google.maps.Map(document.getElementById("map"), {
    center:{ lat:13.4443, lng:144.7937 },
    zoom:11
  });

  map.addListener("click", e => {
    selectedLatLng = e.latLng;
  });

  const sb = new google.maps.places.SearchBox(searchBox);
  sb.addListener("places_changed", () => {
    const p = sb.getPlaces()[0];
    if (!p) return;
    map.panTo(p.geometry.location);
    map.setZoom(15);
    selectedLatLng = p.geometry.location;
    placeName.value = p.name;
  });

  onSnapshot(collection(db,"posts"), snap => {
    markers.forEach(m => m.setMap(null));
    markers = [];

    snap.forEach(d => {
      const data = d.data();

      /* üîí Â£ä„Çå„Åü„Éá„Éº„ÇøÈò≤Ê≠¢ */
      if (
        !data.placeName ||
        typeof data.lat !== "number" ||
        typeof data.lng !== "number"
      ) return;

      const marker = new google.maps.Marker({
        position:{ lat:data.lat, lng:data.lng },
        map
      });

      marker.tags = Array.isArray(data.tags) ? data.tags : [];
      markers.push(marker);

      const buttons =
        data.owner === localStorage.getItem("userId")
        ? `<button onclick="deletePost('${d.id}')">Delete</button>`
        : "";

      const html = `
        <strong>${data.placeName}</strong><br>
        ${data.comment || ""}<br>
        ${data.imageUrl ? `<img src="${data.imageUrl}" style="width:120px;cursor:pointer" onclick="openModal('${data.imageUrl}')">` : ""}
        <br>${buttons}
      `;

      const info = new google.maps.InfoWindow({ content: html });
      marker.addListener("click", () => info.open(map, marker));
    });
  });
};

/* Add post */
window.addSpot = async () => {
  if (!selectedLatLng) {
    alert("Click map or search a place first");
    return;
  }

  const selectedTags = [...document.querySelectorAll('.tags input:checked')]
    .map(cb => cb.value);

  let imageUrl = "";
  const file = imageInput.files[0];
  if (file) {
    const r = ref(storage, "images/" + Date.now());
    await uploadBytes(r, file);
    imageUrl = await getDownloadURL(r);
  }

  await addDoc(collection(db,"posts"), {
    placeName: placeName.value,
    comment: commentInput.value,
    lat: selectedLatLng.lat(),
    lng: selectedLatLng.lng(),
    imageUrl,
    tags: selectedTags,
    owner: localStorage.getItem("userId")
  });

  /* ‚ú® ÊäïÁ®øÂæå„É™„Çª„ÉÉ„Éà */
  placeName.value = "";
  commentInput.value = "";
  imageInput.value = "";
  document.querySelectorAll('.tags input').forEach(cb => cb.checked = false);
  selectedLatLng = null;

  formCard.classList.remove("show");
};

/* Delete */
window.deletePost = async id => {
  if (confirm("Delete this post?")) {
    await deleteDoc(doc(db,"posts",id));
  }
};

/* Filter */
window.filterMarkers = (tag, btn) => {
  document.querySelectorAll(".filters button")
    .forEach(b => b.classList.remove("active"));
  btn.classList.add("active");

  markers.forEach(m => {
    if (tag === "all" || m.tags.includes(tag)) {
      m.setMap(map);
    } else {
      m.setMap(null);
    }
  });
};

/* UI helpers */
window.toggleForm = () => formCard.classList.toggle("show");
window.openModal = src => {
  modalImg.src = src;
  downloadLink.href = src;
  imageModal.style.display = "flex";
};
</script>

<script
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPGlb-Wo-6h4mihUxTWglq0meRqv6zUyM&libraries=places&callback=initMap&language=en"
async defer></script>

</body>
</html>
